<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consent to Video & Audio Recording</title>
  <style>
    :root { --maxw: 860px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; line-height: 1.4; margin: 0; background: #f7f7f8; color:#111827; }
    header { background: white; border-bottom: 1px solid #e5e7eb; }
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 20px; }
    h1 { font-size: 1.35rem; margin: 0; }
    form { background: white; padding: 18px; border: 1px solid #e5e7eb; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    fieldset { border: 0; padding: 0; margin: 0 0 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 700px){ .row { grid-template-columns: 1fr; } }
    label { display: block; font-size: .92rem; color: #374151; margin: 10px 0 6px; }
    input, textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font: inherit; background: #fff; }
    input[disabled] { background:#f9fafb; color:#6b7280; }
    textarea { min-height: 160px; white-space: pre-wrap; }
    .muted { color:#6b7280; font-size: .9rem; }
    .sig-wrap { border: 1px dashed #9ca3af; border-radius: 10px; padding: 10px; background: #fafafa; transition: border-color .15s ease, box-shadow .15s ease; }
    .sig-wrap.invalid { border-color:#ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,.15); }
    canvas { width: 100%; height: 220px; touch-action: none; background: white; border-radius: 8px; border: 1px solid #e5e7eb; }
    @media (max-width: 480px){ canvas { height: 180px; } }
    .btns { display:flex; gap:10px; flex-wrap: wrap; margin-top: 14px; }
    button, .btn { cursor: pointer; border: 1px solid transparent; padding: 10px 14px; border-radius: 10px; background: #111827; color: white; font-weight: 600; }
    .btn.secondary { background: #f3f4f6; color:#111827; border-color:#e5e7eb; }
    .btn.ghost { background:#fff; color:#111827; border:1px solid #e5e7eb; }
    .success { color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:10px 12px; border-radius:10px; }
    .small { font-size: .85rem; color:#6b7280; }
    .hidden { display:none !important; }
    .info { background:#eef2ff; border:1px solid #c7d2fe; color:#1e3a8a; padding:10px 12px; border-radius:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .field-error { color:#991b1b; background:#fef2f2; border:1px solid #fecaca; padding:8px 10px; border-radius:8px; margin-top:8px; font-size:.85rem; }
    .check-wrap { display:flex; align-items:center; gap:10px; width:100%; margin-top:10px; }
    .check-wrap input[type="checkbox"] { flex:0 0 auto; width:18px; height:18px; }
    .check-wrap label { margin:0; flex:1 1 auto; line-height:1.35; text-align:left; white-space:normal; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Consent to Video & Audio Recording (Georgia, USA)</h1>
    </div>
  </header>
  <main class="wrap">
    <form id="consentForm" novalidate autocomplete="on">
      <fieldset class="row">
        <div>
          <label for="fullName">Full Name (as on ID) *</label>
          <input id="fullName" name="name" required placeholder="John A. Doe"
                 autocomplete="name" autocapitalize="words" spellcheck="false" />
        </div>
        <div>
          <label for="dobText">Date of Birth *</label>
          <!-- Mobile-friendly text input + browser autofill -->
          <input id="dobText" name="bdayText" inputmode="numeric" autocomplete="bday"
                 placeholder="MM/DD/YYYY" maxlength="10" spellcheck="false" />
          <!-- Hidden normalized ISO date used by logic -->
          <input id="dob" name="bday" type="hidden" />
        </div>
      </fieldset>

      <fieldset class="row">
        <div>
          <label for="phone">Phone *</label>
          <input id="phone" name="phone" type="tel" required
                 placeholder="(404) 555-1234" autocomplete="tel" inputmode="tel" spellcheck="false" />
        </div>
        <div>
          <label for="email">Email (optional)</label>
          <input id="email" name="email" type="email"
                 placeholder="name@example.com" autocomplete="email"
                 autocapitalize="none" spellcheck="false" />
        </div>
      </fieldset>

      <fieldset id="childrenFieldset">
        <label for="children">Child’s Full Name(s) <span class="muted">(if several, separate by commas)</span></label>
        <input id="children" name="children" placeholder="Jane Doe, Jack Doe" autocomplete="off" />
        <div class="check-wrap">
          <input id="noChildren" name="noChildren" type="checkbox" autocomplete="off" />
          <label for="noChildren">I confirm there are no children.</label>
        </div>
      </fieldset>

      <fieldset>
        <label>Drawn Signature (finger/stylus) *</label>
        <div class="sig-wrap" id="sigWrap">
          <canvas id="sig"></canvas>
          <div class="btns">
            <button type="button" class="btn secondary" id="clearSig">Clear signature</button>
          </div>
          <div class="small">Tip: rotate your phone to landscape for easier signing.</div>
          <div id="sigError" class="field-error hidden">Please provide a drawn signature.</div>
        </div>
      </fieldset>

      <div class="info" style="margin-bottom:12px">
        <span>Please email the generated PDF to
          <a id="emailToLink" href="mailto:yury.semerikov@gmail.com">yury.semerikov@gmail.com</a>.
        </span>
        <button id="copyEmailBtn" type="button" class="btn ghost small" style="padding:6px 10px">Copy</button>
      </div>

      <!-- Honeypot anti-bot field (kept hidden intentionally) -->
      <input type="text" name="website" id="website" class="hidden" autocomplete="off" tabindex="-1" />

      <div class="btns">
        <button id="sendBtn" type="submit" class="btn secondary hidden">Generate PDF & Send</button>
        <button id="downloadOnlyBtn" type="button" class="btn">Download PDF</button>
      </div>

      <div id="msg" style="margin-top:12px" role="status" aria-live="polite" tabindex="-1"></div>

      <fieldset style="margin-top:14px">
        <div class="small" style="margin:6px 0 6px">Preview below is the exact text that will be embedded in the PDF.</div>
        <div id="consentPreview" class="md-preview"></div>
        <!-- Internal storage of rendered markdown (hidden by design) -->
        <textarea id="consentText" name="consentText" class="hidden" readonly></textarea>
      </fieldset>
    </form>
  </main>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <script>
  // ====== SETTINGS ======
  const EMAIL_TO = 'yury.semerikov@gmail.com';
  const RESIDENCE_ADDRESS = '7008 Richland Ct, Roswell, GA 30076';
  // ====== /SETTINGS ======

  // ====== TEMPLATE ======
  const CONSENT_MD_TEMPLATE = `**Consent to Video and Audio Recording at Private Residence**
**(Georgia, USA)**

I, [Full Name], DOB: [DOB], hereby give my informed, voluntary, and ongoing consent to the use of visible (non-hidden) video and audio recording devices located at the residence at [Full Address].

### 1. Scope of Recording
I acknowledge and understand the following:
* Security cameras are installed in common areas of the property and not in bathrooms or toilets.
* The cameras may record both video and audio. Because sound can carry, the recording equipment may capture audio originating from any room within the residence or unit and from immediately adjacent exterior areas (e.g., porch, driveway, yard), even if no camera is physically present in that specific space.
* Upon request, I may be shown the exact location of all installed cameras.

### 2. Duration of Consent
This consent applies to:
* My current and any future visits to the above address, and
* Remains effective until I revoke it as described below.

### 3. Revocation of Consent
To revoke this consent, I must:
* Send written notice to yury.semerikov@gmail.com at least 24 hours before the desired effective time.

Upon revocation, I agree to promptly leave the premises and to notify any adult household member at the earliest possible opportunity.

### 4. Waiver and Release
I waive and release the homeowner from any civil claims arising from such recordings, except in cases of willful misconduct or gross negligence.

### 5. Electronic Signature
Electronic signatures shall be deemed originals under the U.S. E-SIGN Act.

### 6. Acknowledgment
I understand and accept all terms described above and confirm that I am signing this consent voluntarily. I confirm that I am at least 18 years of age and legally competent to sign this consent.

### 7. Consent for Minors
As the parent or legal guardian of [Child’s Full Name(s)], I also provide consent on their behalf under the same terms and conditions.

---
Name: [Full Name]
Phone: [Phone Number]
Email: [Email Address]
Date: [MM/DD/YYYY]
Drawn signature:`;
  // ====== /TEMPLATE ======

  // Element refs
  const form = document.getElementById('consentForm');
  const sigCanvas = document.getElementById('sig');
  const sigWrap = document.getElementById('sigWrap');
  const sigError = document.getElementById('sigError');
  const clearSigBtn = document.getElementById('clearSig');
  const msgEl = document.getElementById('msg');
  const downloadOnlyBtn = document.getElementById('downloadOnlyBtn');
  const consentTextTA = document.getElementById('consentText');
  const consentPreviewEl = document.getElementById('consentPreview');
  const childrenEl = document.getElementById('children');
  const noChildrenEl = document.getElementById('noChildren');
  const emailEl = document.getElementById('email');
  const dobEl = document.getElementById('dob');         // hidden ISO
  const dobTextEl = document.getElementById('dobText'); // visible MM/DD/YYYY
  const copyEmailBtn = document.getElementById('copyEmailBtn');

  let signaturePad;
  let isBusy = false;

  function toast(html, type = 'success') {
    msgEl.innerHTML = `<div class="${type}">${html}</div>`;
    msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    try { msgEl.focus({ preventScroll: true }); } catch {}
  }
  const trimVal = v => (v || '').toString().trim();

  function todayYyyyMmDd(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function slugifyName(s){
    return (s || 'anon')
      .toLowerCase()
      .replace(/[^a-z0-9]+/gi, '_')
      .replace(/^_+|_+$/g, '')
      .replace(/_{2,}/g, '_');
  }

  // ==== DOB helpers (MM/DD/YYYY <-> ISO) ====
  function parseDobTextToIso(v){
    if (!v) return '';
    v = v.replace(/[^\d/]/g, '').trim();
    // allow M/D/YYYY or MM/DD/YYYY
    const parts = v.split('/');
    if (parts.length !== 3) return '';
    let [m, d, y] = parts.map(p => p.trim());
    if (!y || y.length !== 4) return '';
    m = m.padStart(2,'0'); d = d.padStart(2,'0');
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(`${m}/${d}/${y}`)) return '';
    // validate date and range
    const iso = `${y}-${m}-${d}`;
    const dt = new Date(iso + 'T00:00:00');
    if (Number.isNaN(dt.getTime())) return '';
    // check month/day integrity (e.g., 02/30 invalid)
    if (dt.getUTCFullYear() !== +y || (dt.getUTCMonth()+1) !== +m || dt.getUTCDate() !== +d) return '';
    if (iso < '1900-01-01' || iso > todayYyyyMmDd()) return '';
    return iso;
  }
  function formatDobAsMmDdYyyy(){
    const v = dobEl.value;
    if (!v) return '';
    const [y,m,d] = v.split('-');
    return `${m}/${d}/${y}`;
  }
  function autoFormatDobInput(e){
    let v = e.target.value.replace(/[^\d]/g,'');
    if (v.length > 8) v = v.slice(0,8);
    if (v.length > 4) v = v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4);
    else if (v.length > 2) v = v.slice(0,2) + '/' + v.slice(2);
    e.target.value = v;
  }
  function syncDobHiddenFromText(){
    const iso = parseDobTextToIso(trimVal(dobTextEl.value));
    dobEl.value = iso; // empty string if invalid/empty
  }

  // ==== Signature canvas (preserve on resize) ====
  function resizeSignatureCanvas(preserve=true) {
    if (isBusy) return; // don't touch while generating
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = sigCanvas.getBoundingClientRect();
    let saved = null;
    if (preserve && signaturePad && !signaturePad.isEmpty()){
      try { saved = signaturePad.toData(); } catch {}
    }
    sigCanvas.width = rect.width * ratio;
    sigCanvas.height = parseInt(getComputedStyle(sigCanvas).height, 10) * ratio;
    const ctx = sigCanvas.getContext('2d');
    ctx.scale(ratio, ratio);
    if (signaturePad){
      if (saved && saved.length){
        signaturePad.clear();
        try { signaturePad.fromData(saved); } catch {}
      } else {
        signaturePad.clear();
      }
    }
  }

  function initSignatureCanvas(){
    resizeSignatureCanvas(false);
    signaturePad = new SignaturePad(sigCanvas, { minWidth: 0.7, maxWidth: 1.6, penColor: '#111827' });
    clearSigBtn.addEventListener('click', () => { signaturePad.clear(); sigWrap.classList.remove('invalid'); sigError.classList.add('hidden'); });
    sigCanvas.addEventListener('pointerdown', () => { sigWrap.classList.remove('invalid'); sigError.classList.add('hidden'); });
    window.addEventListener('resize', () => resizeSignatureCanvas(true));
  }

  // ====== collect & preview ======
  function collectFormData(){
    return {
      fullName: trimVal(document.getElementById('fullName').value),
      dob: formatDobAsMmDdYyyy(),
      phone: trimVal(document.getElementById('phone').value),
      email: trimVal(emailEl.value),
      children: trimVal(childrenEl.value),
      noChildren: !!noChildrenEl.checked,
      now: (() => {
        const t = new Date();
        const mm = String(t.getMonth()+1).padStart(2,'0');
        const dd = String(t.getDate()).padStart(2,'0');
        const yyyy = t.getFullYear();
        return `${mm}/${dd}/${yyyy}`;
      })(),
    };
  }

  const NAME_ALLOWED_CHARS = /^[A-Za-z0-9 .,'-]+$/;
  const CHILDREN_ALLOWED_CHARS = /^[A-Za-z0-9 .,'-]+(?:\s*,\s*[A-Za-z0-9 .,'-]+)*$/;
  const PHONE_ALLOWED_CHARS = /^[0-9()+\-.\s]+$/;

  function scrollAndFocus(el){
    el.scrollIntoView({ behavior:'smooth', block:'center' });
    try { el.focus({ preventScroll:true }); } catch {}
  }

  function clearCustomValidityAll(){
    ['fullName','phone','email','children','dobText'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.setCustomValidity('');
    });
  }

  function raise(el, message){
    el.setCustomValidity(message || 'Invalid');
    el.reportValidity();
    scrollAndFocus(el);
    throw new Error('__validation__');
  }

  function validateOptionalEmailField(){
    const v = trimVal(emailEl.value);
    if (v && !emailEl.checkValidity()){
      raise(emailEl, 'Please enter a valid email address or clear the field.');
    }
    emailEl.setCustomValidity('');
  }

  function handleChildrenToggle(){
    if (noChildrenEl.checked){
      childrenEl.disabled = true;
      childrenEl.value = '';
      childrenEl.setCustomValidity('');
    } else {
      childrenEl.disabled = false;
    }
    renderConsentMarkdownPreview();
  }
  noChildrenEl.addEventListener('change', handleChildrenToggle);

  function renderConsentMarkdownPreview(){
    const data = collectFormData();
    let s = CONSENT_MD_TEMPLATE;

    const baseTokens = {
      '\\[Full Address\\]': RESIDENCE_ADDRESS,
      '\\[Full Name\\]': data.fullName || '[Full Name]',
      '\\[Phone Number\\]': data.phone || '[Phone Number]',
      '\\[Email Address\\]': data.email || '[Email Address]',
      '\\[MM\\/DD\\/YYYY\\]': data.now,
    };
    for (const [re, val] of Object.entries(baseTokens)){
      s = s.replace(new RegExp(re, 'g'), val);
    }

    // DOB handling: insert if present; if not, drop ", DOB: [DOB], "
    if (data.dob){
      s = s.replace(/\[DOB\]/g, data.dob);
    } else {
      s = s.replace(/,\s*DOB:\s*\[DOB\],\s*/g, ', ');
    }

    // Children block
    if (!(data.children && !data.noChildren)) {
      s = s.replace(/\n### 7\.[\s\S]*?\n---/, '\n---');
    } else {
      s = s.replace(/\[Child’s Full Name\(s\)\]/g, data.children);
    }

    // If no email, drop Email line
    if (!data.email){
      s = s.replace(/^\s*Email:\s*\[Email Address\]\s*$/m, '').replace(/\n{3,}/g, '\n\n');
    }

    consentTextTA.value = s;
    const html = DOMPurify.sanitize(marked.parse(s));
    consentPreviewEl.innerHTML = html;

    return s;
  }

  // Live updates
  ['fullName','phone','email','children','dobText'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => { el.setCustomValidity(''); if (el===dobTextEl){ autoFormatDobInput({target:el}); syncDobHiddenFromText(); } renderConsentMarkdownPreview(); });
    el.addEventListener('change', () => { el.setCustomValidity(''); if (el===dobTextEl){ syncDobHiddenFromText(); } renderConsentMarkdownPreview(); });
  });

  // Unified validation (Name → DOB → Phone → Email → Children → Signature)
  function validateFormOrThrow(){
    clearCustomValidityAll();

    const fullNameEl = document.getElementById('fullName');
    if (!trimVal(fullNameEl.value)) raise(fullNameEl, 'Full Name is required.');
    if (!NAME_ALLOWED_CHARS.test(fullNameEl.value)) raise(fullNameEl, "Use English letters/digits and common symbols only: space . , ' -");

    // DOB optional; if filled — validate MM/DD/YYYY and range
    const dobText = trimVal(dobTextEl.value);
    if (dobText){
      const iso = parseDobTextToIso(dobText);
      if (!iso) raise(dobTextEl, 'Please enter a valid date (MM/DD/YYYY), 1900…today.');
      dobEl.value = iso;
    } else {
      dobEl.value = '';
    }

    const phoneEl = document.getElementById('phone');
    if (!trimVal(phoneEl.value)) raise(phoneEl, 'Phone is required.');
    if (!PHONE_ALLOWED_CHARS.test(phoneEl.value)) raise(phoneEl, 'Phone can include digits, spaces, +, -, (), and . only.');

    validateOptionalEmailField();

    const data = collectFormData();
    if (!data.children && !data.noChildren){
      raise(childrenEl, 'Please enter child’s full name(s) or check “I confirm there are no children.”');
    }
    if (data.children && !CHILDREN_ALLOWED_CHARS.test(data.children)){
      raise(childrenEl, "For names, use English letters/digits and , . ' - (comma-separated).");
    }

    if (!signaturePad || signaturePad.isEmpty()){
      sigWrap.classList.add('invalid');
      sigError.classList.remove('hidden');
      scrollAndFocus(sigCanvas);
      throw new Error('__validation__');
    } else {
      sigWrap.classList.remove('invalid');
      sigError.classList.add('hidden');
    }
  }

  // Markdown → PDF
  function stripInlineBold(t){ return t.replace(/\*\*(.*?)\*\*/g, '$1'); }
  function drawMarkdown(doc, text, startY){
    const margin = 48;
    const paraX = margin + 12;
    const listX = margin + 18;
    const wrapW = 540;
    const pageH = doc.internal.pageSize.getHeight();

    let y = startY;
    let firstBoldSeen = false;

    function ensureSpace(h=14){
      if (y + h > pageH - margin){
        doc.addPage();
        y = margin;
      }
    }

    const lines = text.split('\n');

    for (let raw of lines){
      const line = raw.replace(/\r/g,'');
      if (!line.trim()) { ensureSpace(4); y += 4; continue; }
      if (line.trim() === '---') { ensureSpace(16); y += 16; continue; }

      if (/^###\s+/.test(line)){
        doc.setFont('helvetica','bold'); doc.setFontSize(11);
        ensureSpace(14);
        doc.text(line.replace(/^###\s+/, '').trim(), margin, y);
        y += 12; continue;
      }

      if (/^\*\*.*\*\*$/.test(line.trim())){
        const plain = stripInlineBold(line.trim());
        const isSignatureLabel = /^Drawn signature:$/i.test(plain.trim());
        doc.setFont('helvetica','bold');

        if (!firstBoldSeen){
          doc.setFontSize(15);
          const wrapped = doc.splitTextToSize(plain, wrapW);
          ensureSpace(18 * wrapped.length);
          doc.text(wrapped, margin, y);
          y += 18; firstBoldSeen = true;
        } else if (isSignatureLabel){
          doc.setFontSize(10);
          ensureSpace(12);
          doc.text(plain, paraX, y);
          y += 6;
        } else {
          doc.setFontSize(11);
          const wrapped = doc.splitTextToSize(plain, wrapW);
          ensureSpace(14 * wrapped.length);
          doc.text(wrapped, margin, y);
          y += 12;
        }
        continue;
      }

      if (/^\*\s+/.test(line)){
        const t = stripInlineBold(line.replace(/^\*\s+/, '').trim());
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        const wrapped = doc.splitTextToSize(`• ${t}`, wrapW - (listX - margin));
        ensureSpace(14 * wrapped.length);
        doc.text(wrapped, listX, y);
        y += wrapped.length * 12;
        continue;
      }

      const t = stripInlineBold(line);
      const emailMatch = /^Email:\s+(.+)$/.exec(t);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);

      if (emailMatch){
        const prefix = 'Email: ';
        const email = emailMatch[1].trim();
        ensureSpace(14);
        doc.text(prefix, paraX, y);
        const px = paraX + doc.getTextWidth(prefix);
        if (doc.textWithLink) {
          doc.textWithLink(email, px, y, { url: `mailto:${email}` });
        } else {
          doc.text(email, px, y);
          doc.link(px, y-8, doc.getTextWidth(email), 10, { url: `mailto:${email}` });
        }
        y += 12; continue;
      }

      const wrapped = doc.splitTextToSize(t, wrapW - (paraX - margin));
      ensureSpace(14 * wrapped.length);
      doc.text(wrapped, paraX, y);
      y += wrapped.length * 12;
    }
    return y;
  }

  async function generatePdfFromTemplate(processedMd, signatureDataUrl){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter' });
    const margin = 48;
    const paraX = margin + 12;
    let y = margin;

    y = drawMarkdown(doc, processedMd, y);

    if (signatureDataUrl) {
      y += 6;
      const imgWidth = 260, imgHeight = 84;
      doc.addImage(signatureDataUrl, 'PNG', paraX, y, imgWidth, imgHeight);
      y += imgHeight + 6;
    }

    const nameSlug = slugifyName(collectFormData().fullName);
    const filename = `consent_${nameSlug}_${todayYyyyMmDd()}.pdf`;

    const blob = doc.output('blob');
    const file = new File([blob], filename, { type: 'application/pdf' });
    return { blob, file, filename };
  }

  async function buildPdfFile(){
    validateFormOrThrow();
    const processedMd = renderConsentMarkdownPreview();
    // Important: capture signature before any potential resize
    const sigDataUrl = signaturePad.toDataURL('image/png');
    return await generatePdfFromTemplate(processedMd, sigDataUrl);
  }

  // DOWNLOAD
  async function handleDownloadClick(){
    msgEl.innerHTML = '';
    downloadOnlyBtn.disabled = true;
    const oldText = downloadOnlyBtn.textContent;
    downloadOnlyBtn.textContent = 'Processing…';
    isBusy = true;
    try {
      const { file } = await buildPdfFile();
      const url = URL.createObjectURL(file);
      const a = document.createElement('a'); a.href = url; a.download = file.name; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
      toast('PDF downloaded. You can attach it to any email or messenger.');
    } catch (e){
      if (!(e && e.message === '__validation__')) {
        toast('Failed to generate PDF.', 'error');
      }
    } finally {
      isBusy = false;
      downloadOnlyBtn.disabled = false;
      downloadOnlyBtn.textContent = oldText;
    }
  }

  downloadOnlyBtn.addEventListener('click', handleDownloadClick);

  // SUBMIT → act same as download-only
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (trimVal(document.getElementById('website').value)) return; // honeypot
    await handleDownloadClick();
  });

  // Copy email to clipboard
  copyEmailBtn.addEventListener('click', async () => {
    const btn = copyEmailBtn;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(EMAIL_TO);
      } else {
        const tmp = document.createElement('input');
        tmp.value = EMAIL_TO; document.body.appendChild(tmp);
        tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp);
      }
      const prev = btn.textContent; btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = prev; }, 1200);
    } catch {
      toast('Could not copy email address.', 'error');
    }
  });

  // ==== init ====
  (function init(){
    initSignatureCanvas();
    // Initialize DOB text field behavior and sync
    dobTextEl.addEventListener('input', autoFormatDobInput);
    dobTextEl.addEventListener('blur', () => { syncDobHiddenFromText(); renderConsentMarkdownPreview(); });

    renderConsentMarkdownPreview();
  })();
  </script>
</body>
</html>
